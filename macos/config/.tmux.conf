# ----------------------------------------------------------------------------
# macOS Native Terminal 适配版
# ----------------------------------------------------------------------------

# 1. 修正色彩显示
# 原生终端有时对 Tc (TrueColor) 支持不如 iTerm2 完美，如果发现 vim 颜色怪异，
# 可以尝试把下面这行注释掉，只保留 xterm-256color
set -g default-terminal "xterm-256color"
set-option -ga terminal-overrides ",*256col*:Tc"

# 2. 开启鼠标支持 (原生终端完美支持)
set -g mouse on

# 3. 剪切板修复
# 原生终端不支持 OSC52 复制序列，必须依赖 pbcopy
set -g set-clipboard off # 关闭自动尝试，强制使用下面的绑定
setw -g mode-keys vi

# 绑定 v 进入选择模式
bind -T copy-mode-vi v send -X begin-selection

# 绑定 y 复制并通过管道传给 macOS 系统剪切板
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"

# 鼠标拖拽松开后自动复制
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"

# 4. 基础习惯 (保持你之前的习惯)
set -g history-limit 10000
set -g base-index 1
set -g pane-base-index 1
set-option -sg escape-time 10
set-option -g focus-events on
set -g xterm-keys on

# 5. 快捷键重载
bind -n M-r source-file ~/.tmux.conf \; display "Config reloaded!"

# ==============================================
# Smart Splits 配置 (Neovim 联动)
# ==============================================

# 1. 定义检测逻辑：判断当前面板是否在运行 vim/nvim
# 这是一个复杂的 grep 正则，用来识别 vim, nvim, vimdiff 等进程
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

# ==============================================
# 2. 导航绑定 (Alt + hjkl)
# ==============================================
# 如果是 Vim，发送按键 M-h；否则，Tmux 执行 select-pane -L
bind-key -n M-h if-shell "$is_vim" 'send-keys M-h' 'select-pane -L'
bind-key -n M-j if-shell "$is_vim" 'send-keys M-j' 'select-pane -D'
bind-key -n M-k if-shell "$is_vim" 'send-keys M-k' 'select-pane -U'
bind-key -n M-l if-shell "$is_vim" 'send-keys M-l' 'select-pane -R'

# 兼容 Tmux 的复制模式 (Copy-mode)
# 允许在复制模式下也使用 Alt+hjkl 切换面板
bind-key -T copy-mode-vi 'M-h' select-pane -L
bind-key -T copy-mode-vi 'M-j' select-pane -D
bind-key -T copy-mode-vi 'M-k' select-pane -U
bind-key -T copy-mode-vi 'M-l' select-pane -R

# ==============================================
# 3. 大小调整绑定 (Alt + Shift + hjkl)
# ==============================================
# 注意：M-H 表示 Alt + Shift + h
# 如果是 Vim，发送 M-H；否则，Tmux 执行 resize-pane
bind-key -n M-H if-shell "$is_vim" 'send-keys M-H' 'resize-pane -L 3'
bind-key -n M-J if-shell "$is_vim" 'send-keys M-J' 'resize-pane -D 3'
bind-key -n M-K if-shell "$is_vim" 'send-keys M-K' 'resize-pane -U 3'
bind-key -n M-L if-shell "$is_vim" 'send-keys M-L' 'resize-pane -R 3'

# 放大/恢复
bind -n M-z resize-pane -Z

# 显示窗口编号
bind -n M-i display-panes

# 窗口跳转 Alt+1~9
bind -n M-1 select-pane -t 1
bind -n M-2 select-pane -t 2
bind -n M-3 select-pane -t 3
bind -n M-4 select-pane -t 4
bind -n M-5 select-pane -t 5
bind -n M-6 select-pane -t 6
bind -n M-7 select-pane -t 7
bind -n M-8 select-pane -t 8
bind -n M-9 select-pane -t 9

# 关闭窗口
bind -n M-q kill-pane

# 切换到上一个窗口
bind -n M-p previous-window

# 切换到下一个窗口
bind -n M-n next-window

# 创建一个标签页，并继承当前 pane 的工作目录
bind -n M-t new-window -c "#{pane_current_path}"

# 关闭标签
bind -n M-Q kill-window

# 标签跳转 Alt+1~9
bind -n M-! select-window -t 1
bind -n M-@ select-window -t 2
bind -n M-\# select-window -t 3
bind -n M-$ select-window -t 4
bind -n M-% select-window -t 5
bind -n M-^ select-window -t 6
bind -n M-& select-window -t 7
bind -n M-* select-window -t 8
bind -n M-) select-window -t 9

# ==========================================
# 插件管理 (TPM)
# 终端中执行以下指令安装 Tmux 插件管理器
# git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# 第三步：安装并生效
# 保存配置文件。
# 进入 Tmux。
# 按下 Prefix + I (大写的 i，即 Ctrl-b 然后 Shift-i)。
# 此时屏幕会闪烁，显示 "Installing plugins..."，等待显示 "Done" 即可。
# ==========================================
# 插件安装
set -g @plugin 'tmux-plugins/tpm'            # TPM 插件管理器
set -g @plugin 'tmux-plugins/tmux-sensible'  # 很多合理的默认设置
set -g @plugin 'tmux-plugins/tmux-resurrect' # 保存/恢复环境
set -g @plugin 'tmux-plugins/tmux-continuum' # 自动保存
set -g @plugin 'tmux-plugins/tmux-yank'      # 剪贴板复制
set -g @plugin 'tmux-plugins/tmux-prefix-highlight' # 显示前缀键是否按下

# 配置 Resurrect 插件
set -g @resurrect-capture-pane-contents 'on' # 开启恢复面板内容功能
set -g @resurrect-strategy-vim 'session'     # 恢复 Vim 会话状态
set -g @resurrect-save-shell-history 'on'    # 恢复 Shell 历史记录

# 配置 Continuum 插件
set -g @continuum-restore 'on'               # Tmux 启动时自动恢复上次保存的状态
set -g @continuum-save-interval '5'          # 每 15 分钟自动保存一次

# ==========================================
# Sessionx 插件
# ==========================================
# 必须先安装 fzf (系统层面)
# brew install fzf  (macOS)
# sudo apt install fzf (Linux)
set -g @plugin 'omerxx/tmux-sessionx'

# 推荐配置：修改快捷键为 'o' (open)，默认是 'o'，但建议显式设置一下
set -g @sessionx-bind 'o'

# 推荐配置：使用浮动窗口 (需要 tmux 3.2+)
set -g @sessionx-window-height '85%'
set -g @sessionx-window-width '75%'

# ==========================================
# 主题
# ==========================================
set -g @plugin 'catppuccin/tmux'
set -g @catppuccin_flavour 'mocha'

# ==========================================
# 初始化 TPM (必须放在配置文件的最底部)
# ==========================================
run '~/.tmux/plugins/tpm/tpm'